{"ast":null,"code":"import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nvar _jsxFileName = \"/Users/maricrisbonzo/Desktop/magic-apps/magic-stripe/client/src/components/register.js\",\n    _s = $RefreshSig$();\n\nimport { useState, useEffect } from \"react\";\nimport { Magic } from \"magic-sdk\";\nimport { useUser } from \"../lib/hooks\";\nimport { OAuthExtension } from \"@magic-ext/oauth\";\nimport { WebAuthnExtension } from \"@magic-ext/webauthn\";\nimport Layout from \"./layout\";\nimport SignUpForm from \"./sign-up-form\";\nimport { useHistory } from \"react-router-dom\";\n\nconst stripe = require(\"stripe\")(\"sk_test_51IGbZJBgidwKCIjAxUx0gEs9VVHtkCmmSVHKssJURtIGVgl9ztxJjtZh6TDQoBLJ175t79kfnOcppd8BKGs2JGfb00k1bcGzKP\");\n\nconst Register = () => {\n  _s();\n\n  useUser({\n    redirectTo: \"/\",\n    redirectIfFound: true\n  });\n  const history = useHistory();\n  const [magic, setMagic] = useState(null);\n  const [disabled, setDisabled] = useState(false);\n  useEffect(() => {\n    !magic && setMagic(new Magic(process.env.REACT_APP_MAGIC_PUBLISHABLE_KEY, {\n      extensions: [new OAuthExtension(), new WebAuthnExtension()]\n    }));\n    magic === null || magic === void 0 ? void 0 : magic.preload();\n  }, [magic]);\n\n  async function handleLoginWithEmail(email) {\n    try {\n      console.log(\"hi\");\n      setDisabled(true); // disable login button to prevent multiple emails from being triggered\n\n      let didToken = await magic.auth.loginWithMagicLink({\n        email,\n        redirectURI: `${process.env.REACT_APP_CLIENT_URL}/callback`\n      });\n      console.log(\"hello\");\n      authenticateWithServer(didToken, email);\n      console.log(\"bye\");\n    } catch (error) {\n      setDisabled(false); // re-enable login button - user may have requested to edit their email\n\n      console.log(error);\n    }\n  } // try to login with webauthn, if that fails, revert to registering with webauthn\n\n\n  async function handleLoginWithWebauthn(email) {\n    try {\n      let didToken = await magic.webauthn.login({\n        username: email\n      });\n      authenticateWithServer(didToken);\n    } catch (error) {\n      try {\n        let didToken = await magic.webauthn.registerNewUser({\n          username: email\n        });\n        authenticateWithServer(didToken);\n      } catch (err) {\n        alert(\"Failed to authenticate. Must be using a supported device and a username not already taken.\");\n        console.log(err);\n      }\n    }\n  }\n\n  async function authenticateWithServer(didToken, email) {\n    const res = await fetch(`${process.env.REACT_APP_SERVER_URL}/api/login`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: \"Bearer \" + didToken\n      },\n      credentials: \"include\"\n    });\n\n    if (res.status === 200) {\n      const customer = await stripe.customers.create({\n        email\n      });\n      console.log(\"customer: \", customer);\n      history.push(\"/payment\");\n    }\n  }\n\n  return /*#__PURE__*/_jsxDEV(Layout, {\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"login\",\n      children: /*#__PURE__*/_jsxDEV(SignUpForm, {\n        disabled: disabled,\n        onEmailSubmit: handleLoginWithEmail,\n        onWebauthnSubmit: handleLoginWithWebauthn\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 88,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 87,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"style\", {\n      children: `\n        .login {\n          max-width: 20rem;\n          margin: 40px auto 0;\n          padding: 1rem;\n          border: 1px solid #dfe1e5;\n          border-radius: 4px;\n          text-align: center;\n          box-shadow: 0px 0px 6px 6px #f7f7f7;\n          box-sizing: border-box;\n        }\n      `\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 94,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 86,\n    columnNumber: 5\n  }, this);\n};\n\n_s(Register, \"hTU0G7H8ALR3FHMWq6dBUh1SPkI=\", false, function () {\n  return [useUser, useHistory];\n});\n\n_c = Register;\nexport default Register;\n\nvar _c;\n\n$RefreshReg$(_c, \"Register\");","map":{"version":3,"sources":["/Users/maricrisbonzo/Desktop/magic-apps/magic-stripe/client/src/components/register.js"],"names":["useState","useEffect","Magic","useUser","OAuthExtension","WebAuthnExtension","Layout","SignUpForm","useHistory","stripe","require","Register","redirectTo","redirectIfFound","history","magic","setMagic","disabled","setDisabled","process","env","REACT_APP_MAGIC_PUBLISHABLE_KEY","extensions","preload","handleLoginWithEmail","email","console","log","didToken","auth","loginWithMagicLink","redirectURI","REACT_APP_CLIENT_URL","authenticateWithServer","error","handleLoginWithWebauthn","webauthn","login","username","registerNewUser","err","alert","res","fetch","REACT_APP_SERVER_URL","method","headers","Authorization","credentials","status","customer","customers","create","push"],"mappings":"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","sourcesContent":["import { useState, useEffect } from \"react\";\nimport { Magic } from \"magic-sdk\";\nimport { useUser } from \"../lib/hooks\";\nimport { OAuthExtension } from \"@magic-ext/oauth\";\nimport { WebAuthnExtension } from \"@magic-ext/webauthn\";\nimport Layout from \"./layout\";\nimport SignUpForm from \"./sign-up-form\";\nimport { useHistory } from \"react-router-dom\";\n\nconst stripe = require(\"stripe\")(\n  \"sk_test_51IGbZJBgidwKCIjAxUx0gEs9VVHtkCmmSVHKssJURtIGVgl9ztxJjtZh6TDQoBLJ175t79kfnOcppd8BKGs2JGfb00k1bcGzKP\"\n);\n\nconst Register = () => {\n  useUser({ redirectTo: \"/\", redirectIfFound: true });\n  const history = useHistory();\n  const [magic, setMagic] = useState(null);\n  const [disabled, setDisabled] = useState(false);\n\n  useEffect(() => {\n    !magic &&\n      setMagic(\n        new Magic(process.env.REACT_APP_MAGIC_PUBLISHABLE_KEY, {\n          extensions: [new OAuthExtension(), new WebAuthnExtension()],\n        })\n      );\n    magic?.preload();\n  }, [magic]);\n\n  async function handleLoginWithEmail(email) {\n    try {\n      console.log(\"hi\");\n      setDisabled(true); // disable login button to prevent multiple emails from being triggered\n      let didToken = await magic.auth.loginWithMagicLink({\n        email,\n        redirectURI: `${process.env.REACT_APP_CLIENT_URL}/callback`,\n      });\n      console.log(\"hello\");\n      authenticateWithServer(didToken, email);\n      console.log(\"bye\");\n    } catch (error) {\n      setDisabled(false); // re-enable login button - user may have requested to edit their email\n      console.log(error);\n    }\n  }\n\n  // try to login with webauthn, if that fails, revert to registering with webauthn\n  async function handleLoginWithWebauthn(email) {\n    try {\n      let didToken = await magic.webauthn.login({ username: email });\n      authenticateWithServer(didToken);\n    } catch (error) {\n      try {\n        let didToken = await magic.webauthn.registerNewUser({\n          username: email,\n        });\n        authenticateWithServer(didToken);\n      } catch (err) {\n        alert(\n          \"Failed to authenticate. Must be using a supported device and a username not already taken.\"\n        );\n        console.log(err);\n      }\n    }\n  }\n\n  async function authenticateWithServer(didToken, email) {\n    const res = await fetch(`${process.env.REACT_APP_SERVER_URL}/api/login`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: \"Bearer \" + didToken,\n      },\n      credentials: \"include\",\n    });\n    if (res.status === 200) {\n      const customer = await stripe.customers.create({\n        email,\n      });\n      console.log(\"customer: \", customer);\n      history.push(\"/payment\");\n    }\n  }\n\n  return (\n    <Layout>\n      <div className=\"login\">\n        <SignUpForm\n          disabled={disabled}\n          onEmailSubmit={handleLoginWithEmail}\n          onWebauthnSubmit={handleLoginWithWebauthn}\n        />\n      </div>\n      <style>{`\n        .login {\n          max-width: 20rem;\n          margin: 40px auto 0;\n          padding: 1rem;\n          border: 1px solid #dfe1e5;\n          border-radius: 4px;\n          text-align: center;\n          box-shadow: 0px 0px 6px 6px #f7f7f7;\n          box-sizing: border-box;\n        }\n      `}</style>\n    </Layout>\n  );\n};\n\nexport default Register;\n"]},"metadata":{},"sourceType":"module"}