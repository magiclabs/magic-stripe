{"version":3,"file":"flexible-div.js","sources":["../../../../src/components/layout/flexible-div.tsx"],"sourcesContent":["import React, { useRef, useState, useEffect, useCallback } from 'react';\nimport { ResizePayload, watchResize } from 'watch-resize';\nimport composeRefs from '@seznam/compose-react-refs';\nimport { cssTimeToMilliseconds } from '../../libs/css-time-to-milliseconds';\nimport { forwardRefWrapper } from '../../libs/forward-ref-wrapper';\n\ninterface TransitionStyles {\n  transition: string;\n  height: string;\n  width: string;\n  willChange: string;\n}\n\ninterface TransitionConfig {\n  duration?: string;\n  timingFunction?: string;\n  delay?: string;\n}\n\ninterface FlexibleDivProps extends React.HTMLAttributes<HTMLDivElement> {\n  initialDelay?: number;\n  transition?: boolean | TransitionConfig;\n  applyCSSVariables?: {\n    element?: HTMLElement;\n    transitionVar?: string;\n    heightVar?: string;\n    widthVar?: string;\n  };\n  onResize?: (\n    payload: Omit<ResizePayload<HTMLElement>, 'destroy'> & {\n      transitionStyles: TransitionStyles;\n    },\n  ) => void;\n  onAnimationFrame?: FrameRequestCallback;\n  observerOnly?: boolean;\n  autoWidth?: boolean;\n  autoHeight?: boolean;\n}\n\n/**\n * This component is a container which automatically updates its `height` style\n * property based on the total size of its child nodes. This enables dynamic\n * transitional height behavior.\n */\nexport const FlexibleDiv = /* @__PURE__ */ forwardRefWrapper<HTMLDivElement, FlexibleDivProps>(\n  'FlexibleDiv',\n\n  {\n    initialDelay: 0,\n    transition: true,\n    applyCSSVariables: {},\n    onResize: () => {},\n    style: {},\n    observerOnly: false,\n    autoWidth: false,\n    autoHeight: false,\n  },\n\n  (props, externalRef) => {\n    // --- Data\n\n    const contentElement = useRef<HTMLElement>();\n    const [height, setHeight] = useState<string | number>('auto');\n    const [width, setWidth] = useState<string | number>('auto');\n\n    const isMounted = useRef(false);\n    const isTransitioning = useRef(false);\n    const raf = useRef<number | null>(null);\n\n    // --- Utilities for handling `watch-resize` observer\n\n    /**\n     * Set the `containerElement` ref height based on the given element\n     * or `contentElement` ref as a fallback.\n     */\n    const setContainerElementDimensions = useCallback(\n      (domRect?: DOMRect) => {\n        let rect = domRect;\n        if (!rect) {\n          if (contentElement.current) rect = contentElement.current.getBoundingClientRect();\n          else return;\n        }\n\n        if (!props.autoHeight) {\n          const nextHeight = Math.ceil(rect.height);\n          if (nextHeight !== height) setHeight(`${nextHeight}px`);\n        }\n\n        if (!props.autoWidth) {\n          const nextWidth = Math.ceil(rect.width);\n          if (nextWidth !== width) setWidth(`${nextWidth}px`);\n        }\n      },\n      [height, width],\n    );\n\n    /**\n     * Build styles to transition height.\n     */\n    const buildTransitionStyles = useCallback(\n      (heightOverride?: number, widthOverride?: number): TransitionStyles => {\n        if (props.transition) {\n          let transition = 'height 0.2s ease, width 0.2s ease';\n\n          if (typeof props.transition !== 'boolean') {\n            const { duration, timingFunction, delay } = props.transition;\n\n            transition = `height${duration ? `${duration} ` : ' 0.2s'}${\n              timingFunction ? `${timingFunction} ` : ' ease'\n            }${delay ? `${delay} ` : ' 0s'}`;\n\n            transition += `, width${duration ? `${duration} ` : ' 0.2s'}${\n              timingFunction ? `${timingFunction} ` : ' ease'\n            }${delay ? `${delay} ` : ' 0s'}`;\n          }\n\n          const resolvedHeightOverride = heightOverride ? `${Math.ceil(heightOverride)}px` : null;\n          const resolvedHeight = typeof height === 'string' ? height : `${Math.ceil(height)}px`;\n\n          const resolvedWidthOverride = widthOverride ? `${Math.ceil(widthOverride)}px` : null;\n          const resolvedWidth = typeof width === 'string' ? width : `${Math.ceil(width)}px`;\n\n          return {\n            transition,\n            height: props.autoHeight ? 'auto' : resolvedHeightOverride || resolvedHeight,\n            width: props.autoWidth ? 'auto' : resolvedWidthOverride || resolvedWidth,\n            willChange: 'height, width',\n          };\n        }\n\n        return {\n          transition: 'none',\n          height: 'auto',\n          width: 'auto',\n          willChange: 'unset',\n        };\n      },\n      [props.transition, height, width],\n    );\n\n    /**\n     * Set CSS variables for the generated `transition` and `height` properties.\n     */\n    const applyCSSVariables = useCallback(\n      (heightOverride?: number, widthOverride?: number) => {\n        const { element, heightVar, widthVar, transitionVar } = props.applyCSSVariables!;\n        const transitionStyles = buildTransitionStyles(heightOverride, widthOverride);\n        const elementResolved = element || document.documentElement;\n\n        if (heightVar)\n          elementResolved.style.setProperty(heightVar, props.autoHeight ? 'auto' : transitionStyles.height);\n        if (widthVar) elementResolved.style.setProperty(widthVar, props.autoWidth ? 'auto' : transitionStyles.width);\n        if (transitionVar) elementResolved.style.setProperty(transitionVar, transitionStyles.transition);\n      },\n      [\n        props.applyCSSVariables?.element,\n        props.applyCSSVariables?.heightVar,\n        props.applyCSSVariables?.widthVar,\n        props.applyCSSVariables?.transitionVar,\n      ],\n    );\n\n    /**\n     * Create the resize stream and start observing.\n     */\n    const setupResizeObservable = useCallback(async (): Promise<() => void> => {\n      /*\n        Under the hood, `watchResize` is creating a nested browsing\n        context inside a DOM `<object>`. This nested context has a\n        `window` object that provides the stream of \"resize\" events.\n       */\n      const destroy = await watchResize(contentElement.current!, (payload) => {\n        isTransitioning.current = true;\n        setTimeout(() => {\n          if (isMounted.current) isTransitioning.current = false;\n        }, cssTimeToMilliseconds((props.transition as TransitionConfig)?.duration) + 100);\n\n        const rect = payload.element.getBoundingClientRect();\n        props.onResize?.({ ...payload, transitionStyles: buildTransitionStyles(rect.height, rect.width) });\n        applyCSSVariables(rect.height, rect.width);\n        if (!props.observerOnly) setContainerElementDimensions(rect);\n      });\n\n      return destroy;\n    }, [setContainerElementDimensions, props.observerOnly, buildTransitionStyles, applyCSSVariables, props.transition]);\n\n    /**\n     * Stop observing the resize stream and destroy the subscription (the stream\n     * itself will be garbage collected).\n     */\n    const teardownResizeObservable = useCallback((destroy?: () => void) => {\n      if (destroy) destroy();\n    }, []);\n\n    // --- React lifecycle\n\n    // Setup/teardown the resize observable on component mount/unmount\n    useEffect(() => {\n      let destroyResizeListener: () => void;\n      let timeout: any;\n      isMounted.current = true;\n\n      (async () => {\n        if (props.initialDelay) {\n          timeout = setTimeout(async () => {\n            if (!props.observerOnly) setContainerElementDimensions();\n            destroyResizeListener = await setupResizeObservable();\n          }, props.initialDelay);\n        } else {\n          setContainerElementDimensions();\n          destroyResizeListener = await setupResizeObservable();\n        }\n      })();\n\n      return () => {\n        isMounted.current = false;\n        if (timeout) clearTimeout(timeout);\n        teardownResizeObservable(destroyResizeListener);\n      };\n    }, []);\n\n    useEffect(() => {\n      if (isTransitioning.current && props.onAnimationFrame) {\n        const tick = () => {\n          raf.current = requestAnimationFrame((...args) => {\n            props.onAnimationFrame!(...args);\n            if (isTransitioning.current) tick();\n          });\n        };\n\n        tick();\n      } else {\n        return () => {\n          if (raf.current) cancelAnimationFrame(raf.current);\n        };\n      }\n\n      return undefined;\n    });\n\n    // --- Rendering\n\n    const {\n      children: _1, // unused\n      style: _2, // unused\n      initialDelay: _3, // unused\n      transition: _4, // unused\n      onResize: _5, // unused\n      observerOnly: _6, // unused\n      applyCSSVariables: _7, // unused\n      onAnimationFrame: _8, // unused\n      autoWidth: _9, // unused\n      autoHeight: _10, // unused\n      ...otherProps\n    } = props;\n\n    return props.observerOnly ? (\n      <div style={props.style} {...otherProps} ref={composeRefs<any>(contentElement, externalRef)}>\n        {props.children}\n      </div>\n    ) : (\n      <div\n        style={{\n          position: 'relative',\n          ...props.style,\n          ...buildTransitionStyles(),\n        }}\n        {...otherProps}\n      >\n        <div\n          ref={composeRefs<any>(contentElement, externalRef)}\n          style={{ position: width === 'auto' ? undefined : 'absolute' }}\n        >\n          {props.children}\n        </div>\n      </div>\n    );\n  },\n);\n"],"names":[],"mappings":"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"}