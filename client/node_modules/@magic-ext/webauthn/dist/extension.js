var MagicWebAuthnExtension=function(e){var t,r;function n(e){var t,r,n,i,a=e.length%3,u="";function o(e){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e)}for(t=0,n=e.length-a;t<n;t+=3)u+=o((i=r=(e[t]<<16)+(e[t+1]<<8)+e[t+2])>>18&63)+o(i>>12&63)+o(i>>6&63)+o(63&i);switch(a){case 1:u+=o((r=e[e.length-1])>>2),u+=o(r<<4&63),u+="==";break;case 2:u+=o((r=(e[e.length-2]<<8)+e[e.length-1])>>10),u+=o(r>>4&63),u+=o(r<<2&63),u+="="}return u}function i(e){return n(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function a(e){return n(e).replace(/\+/g,"-").replace(/\//g,"_")}!function(e){e.WebAuthnRegistrationStart="magic_auth_webauthn_registration_start",e.RegisterWithWebAuth="magic_auth_webauthn_register",e.LoginWithWebAuthn="magic_auth_login_with_web_authn",e.WebAuthnLoginVerify="magic_auth_login_with_webauthn_verify",e.GetWebAuthnInfo="magic_user_get_webauthn_credentials",e.UpdateWebAuthnInfo="magic_user_update_webauthn",e.UnregisterWebAuthDevice="magic_user_unregister_webauthn",e.RegisterWebAuthDeviceStart="magic_auth_register_webauthn_device_start",e.RegisterWebAuthDevice="magic_auth_register_webauthn_device"}(t||(t={})),function(e){e.WebAuthnNotSupported="WEBAUTHN_NOT_SUPPORTED",e.WebAuthnCreateCredentialError="WEBAUTHN_CREATE_CREDENTIAL_ERROR"}(r||(r={}));var u=function(e){var t=new Uint8Array(e.response.attestationObject),r=new Uint8Array(e.response.clientDataJSON),n=new Uint8Array(e.rawId),a=e.getClientExtensionResults();return{id:e.id,rawId:i(n),type:e.type,attObj:i(t),clientData:i(r),registrationClientExtensions:JSON.stringify(a)}};function o(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}return function(e){var n,s;function c(){var t;return(t=e.apply(this,arguments)||this).name="webauthn",t.config={},t}s=e,(n=c).prototype=Object.create(s.prototype),n.prototype.constructor=n,n.__proto__=s;var h=c.prototype;return h.createWebAuthnNotSupportError=function(){this.createError(r.WebAuthnNotSupported,"WebAuthn is not supported in this device.",{})},h.createWebAuthCreateCredentialError=function(e){this.createError(r.WebAuthnCreateCredentialError,"Error creating credential: "+e,{})},h.registerNewUser=function(e){try{var r=this;if(!window.PublicKeyCredential)throw r.createWebAuthnNotSupportError();var n=e.nickname,i=void 0===n?"":n;return Promise.resolve(r.request(r.utils.createJsonRpcRequestPayload(t.WebAuthnRegistrationStart,[{username:e.username}]))).then(function(e){var n;function a(a){return r.request(r.utils.createJsonRpcRequestPayload(t.RegisterWithWebAuth,[{id:e.id,nickname:i,transport:n.response.getTransports(),user_agent:navigator.userAgent,registration_response:u(n)}]))}var s=o(function(){return Promise.resolve(navigator.credentials.create({publicKey:e.credential_options})).then(function(e){n=e})},function(e){throw r.createWebAuthCreateCredentialError(e)});return s&&s.then?s.then(a):a()})}catch(e){return Promise.reject(e)}},h.login=function(e){try{var r=this;if(!window.PublicKeyCredential)throw r.createWebAuthnNotSupportError();var n=e.username;return Promise.resolve(r.request(r.utils.createJsonRpcRequestPayload(t.LoginWithWebAuthn,[{username:n}]))).then(function(e){var u;function s(e){return r.request(r.utils.createJsonRpcRequestPayload(t.WebAuthnLoginVerify,[{username:n,assertion_response:(o=u,c=new Uint8Array(o.response.authenticatorData),h=new Uint8Array(o.response.clientDataJSON),l=new Uint8Array(o.rawId),g=new Uint8Array(o.response.signature),p=o.getClientExtensionResults(),{id:o.id,rawId:i(l),type:o.type,authData:a(c),clientData:a(h),signature:(s=g,Array.from(s).map(function(e){return("0"+e.toString(16)).substr(-2)}).join("")),assertionClientExtensions:JSON.stringify(p)})}]));var o,s,c,h,l,g,p}var c=o(function(){return Promise.resolve(navigator.credentials.get({publicKey:e})).then(function(e){u=e})},function(e){throw r.createWebAuthCreateCredentialError(e)});return c&&c.then?c.then(s):s()})}catch(e){return Promise.reject(e)}},h.updateInfo=function(e){var r=this.utils.createJsonRpcRequestPayload(t.UpdateWebAuthnInfo,[{webAuthnCredentialsId:e.id,nickname:e.nickname}]);return this.request(r)},h.unregisterDevice=function(e){var r=this.utils.createJsonRpcRequestPayload(t.UnregisterWebAuthDevice,[{webAuthnCredentialsId:e}]);return this.request(r)},h.registerNewDevice=function(e){void 0===e&&(e="");try{var r=this;if(!window.PublicKeyCredential)throw r.createWebAuthnNotSupportError();return Promise.resolve(r.request(r.utils.createJsonRpcRequestPayload(t.RegisterWebAuthDeviceStart,[]))).then(function(n){var i;function a(n){return r.request(r.utils.createJsonRpcRequestPayload(t.RegisterWebAuthDevice,[{nickname:e,transport:i.response.getTransports(),user_agent:navigator.userAgent,registration_response:u(i)}]))}var s=o(function(){return Promise.resolve(navigator.credentials.create({publicKey:n.credential_options})).then(function(e){i=e})},function(e){throw r.createWebAuthCreateCredentialError(e)});return s&&s.then?s.then(a):a()})}catch(e){return Promise.reject(e)}},h.getMetadata=function(){var e=this.utils.createJsonRpcRequestPayload(t.GetWebAuthnInfo,[]);return this.request(e)},c}(e.Extension.Internal)}(Magic);
