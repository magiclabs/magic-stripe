"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var types_1 = require("@magic-sdk/types");
var sdk_exceptions_1 = require("../core/sdk-exceptions");
var json_rpc_1 = require("../core/json-rpc");
var promise_tools_1 = require("../util/promise-tools");
var BaseModule = /** @class */ (function () {
    function BaseModule(sdk) {
        this.sdk = sdk;
    }
    Object.defineProperty(BaseModule.prototype, "transport", {
        /**
         * The `PayloadTransport` for the SDK instance registered to this module.
         */
        get: function () {
            return this.sdk.transport;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseModule.prototype, "overlay", {
        /**
         * The `ViewController` for the SDK instance registered to this module.
         */
        get: function () {
            return this.sdk.overlay;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Emits promisified requests to the Magic `<iframe>` context.
     */
    BaseModule.prototype.request = function (payload) {
        var responsePromise = this.transport.post(this.overlay, types_1.MagicOutgoingWindowMessage.MAGIC_HANDLE_REQUEST, json_rpc_1.standardizeJsonRpcRequestPayload(payload));
        // PromiEvent-ify the response.
        var promiEvent = promise_tools_1.createPromiEvent(function (resolve, reject) {
            responsePromise
                .then(function (res) {
                cleanupEvents();
                if (res.hasError)
                    reject(new sdk_exceptions_1.MagicRPCError(res.payload.error));
                else if (res.hasResult)
                    resolve(res.payload.result);
                else
                    throw sdk_exceptions_1.createMalformedResponseError();
            })
                .catch(function (err) {
                cleanupEvents();
                reject(err);
            });
        });
        // Listen for events from the `<iframe>` associated with the current payload
        // and emit those to `PromiEvent` subscribers.
        var cleanupEvents = this.transport.on(types_1.MagicIncomingWindowMessage.MAGIC_HANDLE_EVENT, function (evt) {
            var _a;
            var response = evt.data.response;
            if (response.id === payload.id && ((_a = response.result) === null || _a === void 0 ? void 0 : _a.event)) {
                var _b = response.result, event_1 = _b.event, _c = _b.params, params = _c === void 0 ? [] : _c;
                promiEvent.emit.apply(promiEvent, tslib_1.__spread([event_1], params));
            }
        });
        return promiEvent;
    };
    return BaseModule;
}());
exports.BaseModule = BaseModule;
//# sourceMappingURL=base-module.js.map